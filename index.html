<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Face Recognition - Teachable Machine</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f5f5f5; padding: 20px; }
    h2 { margin-bottom: 10px; }
    #controls { margin: 20px; }
    #webcam-container { margin-top: 20px; display: inline-block; }
    #label-container { margin-top: 15px; font-size: 20px; font-weight: bold; max-height: 200px; overflow-y: auto; }
    button, input, select { padding: 8px 12px; margin: 5px; font-size: 14px; }
    video, canvas { border-radius: 10px; border: 3px solid #333; }
  </style>
</head>
<body>
  <h2>Teachable Machine - Face Recognition</h2>

  <div id="controls">
    <button id="start-btn">Start Recognition</button>
    <button id="stop-btn" disabled>Stop Recognition</button>
    <br>
    <label>Webcam Width: <input type="number" id="cam-width" value="320" min="100" max="1280"></label>
    <label>Height: <input type="number" id="cam-height" value="320" min="100" max="1280"></label>
    <label>Flip Webcam: 
      <select id="cam-flip">
        <option value="true" selected>Yes</option>
        <option value="false">No</option>
      </select>
    </label>
    <br>
    <label>Confidence Threshold: <input type="range" id="conf-threshold" min="0" max="1" step="0.01" value="0.8">
      <span id="conf-value">0.8</span>
    </label>
  </div>

  <div id="webcam-container"></div>
  <div id="label-container"></div>

  <script>
    const URL = "./my_model/"; // your model folder
    let model, webcam, labelContainer, maxPredictions, rafId;

    const startBtn = document.getElementById("start-btn");
    const stopBtn = document.getElementById("stop-btn");
    const confSlider = document.getElementById("conf-threshold");
    const confValue = document.getElementById("conf-value");

    confSlider.oninput = () => { confValue.innerText = confSlider.value; };

    startBtn.onclick = init;
    stopBtn.onclick = stopRecognition;

    async function init() {
      startBtn.disabled = true;
      labelContainer = document.getElementById("label-container");
      labelContainer.innerHTML = "Loading model...";

      // Load model
      try {
        model = await tmImage.load(URL + "model.json", URL + "metadata.json");
        maxPredictions = model.getTotalClasses();
      } catch (err) {
        labelContainer.innerHTML = "‚ùå Failed to load model.";
        console.error(err);
        startBtn.disabled = false;
        return;
      }

      // Setup webcam
      try {
        const width = parseInt(document.getElementById("cam-width").value);
        const height = parseInt(document.getElementById("cam-height").value);
        const flip = document.getElementById("cam-flip").value === "true";

        webcam = new tmImage.Webcam(width, height, flip);
        await webcam.setup();
        await webcam.play();
        document.getElementById("webcam-container").appendChild(webcam.canvas);
      } catch (err) {
        labelContainer.innerHTML = "‚ùå Cannot access webcam.";
        console.error(err);
        startBtn.disabled = false;
        return;
      }

      labelContainer.innerHTML = "üì∑ Webcam started";
      stopBtn.disabled = false;
      loop();
    }

    async function loop() {
      if (!webcam || !webcam.canvas) return;
      webcam.update();
      await predict();
      rafId = window.requestAnimationFrame(loop);
    }

    async function predict() {
      if (!model || !webcam || !webcam.canvas) return;
      try {
        const prediction = await model.predict(webcam.canvas);
        const threshold = parseFloat(confSlider.value);
        let highest = prediction[0];

        for (let i = 1; i < prediction.length; i++) {
          if (prediction[i].probability > highest.probability) highest = prediction[i];
        }

        // Display recognition message
        if (highest.probability > threshold) {
          labelContainer.innerHTML = `‚úÖ ${highest.className} (${(highest.probability*100).toFixed(1)}%)`;
        } else {
          labelContainer.innerHTML = "üö´ Unknown Face";
        }

        // Scrollable list of all predictions
        let allLabels = "<br><strong>All probabilities:</strong><br>";
        prediction.forEach(p => {
          allLabels += `${p.className}: ${(p.probability*100).toFixed(1)}%<br>`;
        });
        labelContainer.innerHTML += allLabels;

      } catch (err) {
        console.error("Prediction error:", err);
      }
    }

    function stopRecognition() {
      if (webcam) webcam.stop();
      window.cancelAnimationFrame(rafId);
      startBtn.disabled = false;
      stopBtn.disabled = true;
      labelContainer.innerHTML = "Recognition stopped.";
    }
  </script>
</body>
</html>
